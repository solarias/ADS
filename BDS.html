<html>
  <head>
    <title>Bonnie Bear Dialogue Simulator</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        border: 0;
        font-family: 'sans-serif';
      }
      html {
        width: 100%;
        height: 100%;
        background-color: #0C1A32;
      }
      body {
        width: 100%;
        height: 100%;
        background-color: #0C1A32;

        color:white;
      }
      #left {
        position: fixed;
        left: 0;top: 0;
        z-index: 1;
        overflow-y: scroll;

        width: 500px;
        height: 100%;
        padding: 10px 10px 100px 10px;
        border-right: 1px #A0A0A0 solid;
        border-bottom: 1px #A0A0A0 solid;
        scrollbar-color: #A0A0A0 #0C1A32;
        box-sizing: border-box;
      }
      #left ul {
        margin-bottom: 10px;
        margin-left: 20px;
        color: white;
      }
        #left li.chapter_link.curruntPosition {
          text-decoration: underline;
          color: lime;
        }
        #left li.chapter_link:hover {
          cursor: pointer;
          text-decoration: underline;
          color: lime;
        }
      #right {
        position: fixed;
        left: 500px;top: 0;
        z-index: 1;

        width: calc(100% - 500px);
        height: 100%;
        box-sizing: border-box;
        background-color: #0C1A32;
        scrollbar-color: #A0A0A0 #0C1A32;
      }
        #load {
          position: absolute;
          left: 0;top: 0;
          z-index: 2;

          width: 100%;
          height: 100%;
          padding: 5px 10px;
          background-color: #0C1A32;
          box-sizing: border-box;

          font-size: 20px;
        }
          #load .subtitle {
            margin-top: 50px;
          }
          #load .settingsContainer {
            width: 100%;
            height:auto;
            padding: 10px;
            background-color:#112547;
            border-radius: 10px;
            box-sizing: border-box;
          }
          #load .referHeader {
            color: orange;
          }
          #load select {
            width: 150px;
          }
          #load button#run {
            background-image: linear-gradient(#f7f8fa ,#e7e9ec);
            border-color: #adb1b8 #a2a6ac #8d9096;
            border-style: solid;
            border-width: 1px;
            border-radius: 3px;
            box-shadow: rgba(255,255,255,.6) 0 1px 0 inset;
            box-sizing: border-box;
            color: #0f1111;
            cursor: pointer;
            font-family: "Amazon Ember",Arial,sans-serif;
            font-size: 14px;
            height: 29px;
            font-size: 13px;
            outline: 0;
            overflow: hidden;
            padding: 0 11px;
            text-align: center;
            text-decoration: none;
            text-overflow: ellipsis;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            white-space: nowrap;
          }
          
          #load .notReady {
            opacity: 0.2;
            pointer-events: none;
            user-select: none;
          }

        #top {
          overflow-y: scroll;

          width: 100%;
          height: calc(100% - 80px);
          padding: 5px 10px;
          border-bottom: 1px #A0A0A0 solid;
          box-sizing: border-box;
        }
          #top .chatCover {
            display: block;

            margin-left:100px;
            margin-bottom: 20px;
            width: 800px;
            height: auto;
            border-radius: 10px;

            font-weight: bold;
          }
                #top .chatCover {
                  background-color: #112547;
                  color: #FFFFFF;
                }
              #top .chatCover.hidden {
                display: none;
              }
              #top .chatCover.oPlayer, #top .chatCover.subtitle {
                margin-left:0px;
              }
                #top .chatCover.oPlayer {
                  background-color: oklab(40.719% 0.07699 -0.12662);
                  color: #FFFFFF;
                }
                #top .chatCover.subtitle {
                  width: 100%;
                  background-color: orange;
                  color: black;
                }
            #top .chatName {
              width:100%;
              height: 30px;
              padding:5px 10px;
              border: 1px #A0A0A0 solid;
              border-top-left-radius: 10px;
              border-top-right-radius: 10px;
              box-sizing: border-box;

              font-size: 15px;
              line-height: 20px;
            }
                #top .subtitle .chatName {
                height: 35px;
                  border-radius: 10px;
                  font-size: 20px;
                  line-height: 25px;
                }
            #top .chatText {
              width:100%;
              height: auto;
                min-height:30px;
              padding:10px 10px;
              border: 1px #A0A0A0 solid;
              box-sizing: border-box;

              font-size: 20px;
              line-height: 25px;
              word-break: keep-all;
            }
                #top .subtitle .chatText {
                  display: none;
                }
              #top .chatText hr {
                margin:5px 0;
                border-top:1px #A0A0A0 solid;
              }
              #top .chatText .small {
                font-size: 15px;
                line-height: 20px;
              }
            #top .chatLine {
              text-overflow: ellipsis;
              overflow: hidden;
              white-space: nowrap;
              opacity: 0.6;

              width:100%;
              height: 20px;
              padding:5px 10px;
              border: 1px #A0A0A0 solid;
              border-bottom-left-radius: 10px;
              border-bottom-right-radius: 10px;
              box-sizing: border-box;

              font-size: 10px;
              line-height: 10px;
            }
                #top .subtitle .chatLine {
                  display: none;
                }
        #bottom {
          width: 100%;
          height: 70px;
          padding: 10px 20px;
          box-sizing: border-box;
        }
          #bottom_location {
            width: 100%;
            height: 40px;

            font-size: 30px;
            line-height: 40px;
          }
          #bottom_info {
            width: 100%;
            height: 20px;

            font-size: 15px;
            line-height: 20px;
            color: #b0b0b0;
          }
    </style>
  </head>
  <body>

    <div id="left"></div>
      <div id="right">
        <div id="load">
          <span class="subtitle">1. Load a Excel file (.xlsx / It loads a column info at first sheet.)</span>
          <br>
          <input id="loadFile" type="file">
          <br>
          <br>
          <span class="subtitle">2. Column Settings</span>
          <div class="settingsContainer">
            1) <span class='referHeader'>"Subtitle"</span> Column : <select data-type="subtitle" data-necessary="yes" class="columnSettings"></select> ("Column A" at sheets)
            <br>
            2) <span class='referHeader'>"Object"</span> Column : <select data-type="object" data-necessary="yes" class="columnSettings"></select>
            <br>
            3) <span class='referHeader'>"Text 1st"</span> Column : <select data-type="text1" data-necessary="yes" class="columnSettings"></select>
            <br>
            4) <span class='referHeader'>"Text 2nd"</span> Column : <select data-type="text2" data-necessary="no" class="columnSettings"></select>
            <br>
            5) <span class='referHeader'>"Text 3rd"</span> Column : <select data-type="text3" data-necessary="no" class="columnSettings"></select>
          </div>
          <br>
          <span class="subtitle">3. Run!</span>
          <br>
          <button id="run" class="notReady" disabled>Run</button>
        </div>
        <div id="top"></div>
        <div id="bottom">
          <div id="bottom_location">Location : </div>
          <div id="bottom_info">[Num. 1] : Previous Chapter&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;[Num. 2] : Next Chapter</div>
        </div>
      </div>
    
  </body>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.26.0/polyfill.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  <script>

  (async () => {
  
  //변수 세팅
  let workbook = undefined//대사집 저장용
  let header = []
  let refHeader = {}
  let pool = {}//데이터 관리 개체 (챕터별로 묶어서 관리)
  let chapterList = []//챕터 개별 관리 배열
  let location = ""//현재 출력 챕터 정보 (챕터 제목으로 기억)

  //함수 : 엑셀 호출해놓기
  async function initExcel(file) {
    //대사집 호출
    workbook = new ExcelJS.Workbook()
    await workbook.xlsx.load(file)

    //header 정보 파악
    worksheet = workbook.getWorksheet(1)
    worksheet.getRow(1).eachCell(cell => {
      header.push(cell.address + " : " + (cell.text))
    })

    //settings에 열 정보 집어넣기
    document.querySelectorAll(".columnSettings").forEach(dom => {
      //필수값이 아니면 미선택 option 집어넣기
      if (dom.dataset.necessary === "no") {
        let option = document.createElement("option")
        option.value = "noUse"
        option.textContent = "** Do not use **"
        dom.appendChild(option)
      }
      header.forEach((headerCell,i) => {
        let option = document.createElement("option")
        option.value = (i+1).toString()
        option.textContent = headerCell
        dom.appendChild(option)
      })
    })

    //localStorage에서 이전 settings 값 불러오기
    let beforeSetting = localStorage.getItem("BDS_settings")
    if (beforeSetting !== null) beforeSetting = JSON.parse(beforeSetting)
    for (let key in beforeSetting) {
      let dom = document.querySelector('select[data-type="' + key + '"]')
      if (dom !== null) {
        for (let i = 0; i < dom.options.length; i++) {
          if (dom.options[i].value === beforeSetting[key] || parseInt(dom.options[i].value) === beforeSetting[key]) {
            dom.value = beforeSetting[key]
            break
          }
        }
      }
    }

    //실행 버튼 표시 및 클릭
    document.getElementById("run").classList.remove("notReady")
    document.getElementById("run").disabled = false
    document.getElementById("run").onclick = async () => {
      //참고 헤더 저장
      document.querySelectorAll(".columnSettings").forEach(async (dom) => {
        let value = dom.value
        if (!isNaN(value)) value = parseInt(value)
        refHeader[dom.dataset.type] = value
      })

    //localStorage에서 이전 settings 값 저장하기
    localStorage.setItem("BDS_settings", JSON.stringify(refHeader))
      
      //기동
      await init()
      
      //기동 이후, 이전 대화 열기
      let localLocation = localStorage.getItem("BDS_location")
      if (localLocation !== null) {
        await chat(localLocation)//출력 : 기존 대화목록
      } else {
        await chat(chapterList[0])//출력 : 첫 대화목록
      }
    }
  }

  //함수 : 기동
  async function init() {

    //파일 입력창 제거
    document.getElementById("load").style.display = "none"

    //챕터별 대화목록 추출 및 정리
    workbook.worksheets.forEach(async (sheet,i) => {
      pool[sheet.name] = []//챕터 생성
      chapterList.push(sheet.name)//챕터 루프용 생성
      sheet.eachRow((row,j) => {
        if (j !== 1) {//헤더는 제외
          let chapter = {}
          //subtitle 칸이 있으면: subtitle 추가
          if (row.getCell(refHeader.subtitle).text !== null && row.getCell(refHeader.subtitle).text.length > 0) {
            chapter = {}
            chapter.type = "subtitle"
            //텍스트가 없는 subtitle은 더 강조
            if (row.getCell(refHeader.object).text === null || row.getCell(refHeader.object).text.length === 0) {
            chapter.speaker = "### " + row.getCell(refHeader.subtitle).text + " ###"
            } else {
              chapter.speaker = "* " + row.getCell(refHeader.subtitle).text
            }
            chapter.text = ""
            chapter.line = ""
            pool[sheet.name].push(chapter)
          }
          //object 칸이 있으면: dialogue 추가
          if (row.getCell(refHeader.object).text !== null && row.getCell(refHeader.object).text.length > 0) {
            chapter = {}
            chapter.type = "dialogue"
            chapter.speaker = row.getCell(refHeader.object).text
            chapter.text = row.getCell(refHeader.text1).text
              if (refHeader.text2 !== "noUse") chapter.text += "<hr><span class='small'>" + row.getCell(refHeader.text2).text + "</span>"
              if (refHeader.text3 !== "noUse") chapter.text += "<hr><span class='small'>" + row.getCell(refHeader.text3).text + "</span>"
              chapter.text = chapter.text.replaceAll("\n","<br>")
            chapter.line = j.toString()
            pool[sheet.name].push(chapter)
          }
        }
      })
    })
    console.log(pool)

    //라인이 가장 많은 챕터 찾기 - 대화틀 생성 참고용
    let longestLine = 1
    for (let chapterName in pool) {
      pool[chapterName].forEach((line,i) => {
        if (longestLine < i + 1) longestLine = i + 1
      })
    }

    //대화목록 목록 생성
    let list = document.createElement("ul"), item
    chapterList.forEach((chapterName,i) => {
      item = document.createElement("li")
      item.id = "Chapter_" + chapterName
      item.classList.add("chapter_link")
      item.innerHTML = chapterName
      list.appendChild(item)
    })
    document.getElementById("left").appendChild(list)

    //대화목록 목록 클릭 이벤트
    document.querySelectorAll(".chapter_link").forEach(dom => {
      dom.onclick = () => {
        chat(dom.id.replace("Chapter_",""))
      }
    })

    //대화틀 생성 : 가장 긴 대화목록 수량만큼 제작
    for (let i = 0 ; i < longestLine ; i++) {
      //틀
      let chatCover = document.createElement("div")
      chatCover.id = "chatCover" + "_" + i.toString()
      chatCover.classList.add("chatCover")
      chatCover.classList.add("hidden")
        //이름
        let chatName = document.createElement("div")
        chatName.id = "chatName" + "_" + i.toString()
        chatName.className = "chatName"
        chatCover.appendChild(chatName)
        //텍스트
        let chatText = document.createElement("div")
        chatText.id = "chatText" + "_" + i.toString()
        chatText.className = "chatText"
        chatCover.appendChild(chatText)
        //라인
        let chatLine = document.createElement("div")
        chatLine.id = "chatLine" + "_" + i.toString()
        chatLine.className = "chatLine"
        chatCover.appendChild(chatLine)
      document.getElementById("top").appendChild(chatCover)
    }

  }

  //함수 : 출력
  async function chat(destination) {
    //대화목록 텍스트 수정 (가능하지 않으면 미실시)
    if (document.getElementById("Chapter_" + location.toString()) !== null) {
      document.getElementById("Chapter_" + location.toString()).innerHTML = document.getElementById("Chapter_" + location.toString()).innerHTML.replaceAll(" ◇◆◇","")
      document.getElementById("Chapter_" + location.toString()).classList.remove("curruntPosition")
    }
    //지정한 대화목록이 없으면 실행 종료 (필터나 업데이트 등으로 인해 지정할 대상이 없는 경우)
    if (document.getElementById("Chapter_" + destination.toString()) === null) {
      return
    }
    document.getElementById("Chapter_" + destination.toString()).innerHTML += " ◇◆◇"
    document.getElementById("Chapter_" + destination.toString()).classList.add("curruntPosition")
    //위치 정보 수정, 출력위치 임시저장
    location = destination
    localStorage.setItem("BDS_location", location)
    //대화목록 스크롤(화면을 벗어날 경우)
    let dest = document.getElementById("Chapter_" + destination.toString())
    let rect = dest.getBoundingClientRect()
    let viewHeight = document.getElementById("left").clientHeight
    if (rect.top < 80) {
      document.getElementById("left").scrollTop = dest.offsetTop - 80
    } else if (rect.bottom > viewHeight - 80) {
      document.getElementById("left").scrollTop = dest.offsetTop - viewHeight + 80
    }
    //모든 대화틀 숨기기 및 특성/필터 초기화
    for (let chatCover of document.getElementById("top").childNodes) {
      chatCover.classList.add("hidden")
      chatCover.classList.remove("oPlayer")
      chatCover.classList.remove("subtitle")
    }
    //대화 정보 불러오기
    let infoArr = pool[location]
    //대화 타이틀 표시
    document.getElementById("bottom_location").innerHTML = "Location : " + location
    //대화 구성
    infoArr.forEach((info,i) => {
      document.getElementById("chatCover_" + i.toString()).classList.remove("hidden")
        if (info.speaker.indexOf("oPlayer") >= 0) document.getElementById("chatCover_" + i.toString()).classList.add("oPlayer")
        if (info.type === "subtitle") document.getElementById("chatCover_" + i.toString()).classList.add("subtitle")
      document.getElementById("chatName_" + i.toString()).innerHTML = info.speaker
      document.getElementById("chatText_" + i.toString()).innerHTML = info.text
      document.getElementById("chatLine_" + i.toString()).innerHTML = "Line : " + info.line
    })
    //대화창 스크롤
    document.getElementById("top").scrollTop = 0
  }

    
  window.onload = async () =>{

    try {

      document.getElementById("loadFile").onchange = async (e) => {
        document.getElementById("loadFile").classList.add("notReady")//파일 업로드 비활성화
        document.getElementById("loadFile").disabled = true
        await initExcel(e.target.files[0])//엑셀 호출
      }

      document.addEventListener('keydown', async (event) => {
        let locationNum = chapterList.indexOf(location)
        if (locationNum < 0) return
        const keyName = event.key
        if (keyName === '2') {
          if (locationNum < chapterList.length - 1) {
            chat(chapterList[locationNum + 1])
          }
        } else if (keyName === '1') {
          if (locationNum > 0) {
            chat(chapterList[locationNum - 1])
          }
        }
      })

    } catch(err) {
      alert("※ ERROR! Please report it to the developer.\n" + err)
    }
  }

  })()

  </script>
</html>